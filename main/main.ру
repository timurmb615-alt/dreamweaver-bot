from fastapi import FastAPI
from pydantic import BaseModel
import httpx
import os

app = FastAPI()

print("DEBUG: LOADED MAIN.PY, APP =", type(FastAPI))

OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")

class DreamRequest(BaseModel):
    user_dream: str

@app.post("/generate_dream")
async def generate_dream(req: DreamRequest):
    prompt = (
        "Создай короткий сон (примерно 200 слов) на основе описания пользователя: "
        f"\"{req.user_dream}\". Стиль: спокойный, кинематографичный, позитивный, с хэппи-эндом. "
        "Пиши по-русски, без лишних пояснений, только сам сон."
    )

    async with httpx.AsyncClient(timeout=30.0) as client:
        resp = await client.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                "Content-Type": "application/json",
                # Рекомендуется указывать origin
                "HTTP-Referer": "https://dreamweaver-bot",  # можно свой домен/название
                "X-Title": "DreamWeaverBot",
            },
            json={
                "model": "gpt-4o-mini",  # можно поменять на любую модель OpenRouter
                "messages": [
                    {"role": "system", "content": "Ты пишешь красивые, но краткие сны."},
                    {"role": "user", "content": prompt},
                ],
                "max_tokens": 600,
            },
        )

    resp.raise_for_status()
    data = resp.json()
    text = data["choices"][0]["message"]["content"].strip()
    return {"dream_text": text}
